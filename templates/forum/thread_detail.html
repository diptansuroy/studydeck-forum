{% extends 'forum/base.html' %}

{% block content %}
<div id="loader" class="text-center mt-5"><div class="spinner-border text-primary"></div></div>

<div id="content" class="d-none">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="/forum/" class="btn btn-outline-secondary">&larr; Back to Forum</a>
        
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#reportModal">
                <i class="fas fa-flag"></i> Report
            </button>

            <div id="mod-actions" class="d-none border-start ps-2 ms-2">
                <button class="btn btn-outline-warning btn-sm" onclick="togglePin()" id="pin-btn" title="Pin Thread">
                    <i class="fas fa-thumbtack"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="toggleLock()" id="lock-btn" title="Lock Thread">
                    <i class="fas fa-lock"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteThread()" title="Delete Thread">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4 border-primary">
        <div class="card-body">
            <h2 class="card-title text-primary">
                <span id="pinned-icon" class="d-none"><i class="fas fa-thumbtack text-warning"></i></span>
                <span id="t-title"></span>
                <span id="locked-icon" class="d-none"><i class="fas fa-lock text-danger ms-2" title="Locked"></i></span>
            </h2>
            <div class="mb-3 text-muted">
                <span class="badge bg-secondary" id="t-category"></span>
                <span class="ms-2" id="t-author"></span>
                <span class="ms-2" id="t-date"></span>
            </div>
            <div class="card-text fs-5" id="t-content"></div>
            <hr>
            <div class="d-flex gap-3">
                <button class="btn btn-sm btn-outline-danger" onclick="likeThread()">
                    <i class="far fa-heart"></i> <span id="t-likes">0</span>
                </button>
            </div>
        </div>
    </div>

    <h4 class="mb-3">Replies (<span id="reply-count">0</span>)</h4>
    <div id="replies-container"></div>

    <div class="card mt-4 bg-light" id="reply-section">
        <div class="card-body">
            <h5 class="card-title">Leave a Reply</h5>
            <textarea id="replyContent" class="form-control mb-2" rows="3" placeholder="Write your answer (Markdown supported)..."></textarea>
            <button class="btn btn-primary" onclick="postReply()">Post Reply</button>
        </div>
    </div>
    
    <div id="locked-message" class="alert alert-warning mt-4 d-none">
        <i class="fas fa-lock"></i> This thread is locked. You cannot reply.
    </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Report Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="mb-3">
                        <label>Reason for reporting:</label>
                        <textarea id="reportReason" class="form-control" rows="3" required placeholder="e.g., Harassment, Spam, Incorrect Info"></textarea>
                    </div>
                    <button type="submit" class="btn btn-danger w-100">Submit Report</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const pathSegments = window.location.pathname.split('/').filter(Boolean);
    const THREAD_ID = pathSegments[pathSegments.length - 1]; 
    let CURRENT_USER_EMAIL = ""; 

    document.addEventListener('DOMContentLoaded', async () => {
        await loadCurrentUser();
        loadThreadDetail();
    });

    // --- HELPER FOR MARKDOWN ---
    function renderMarkdown(text) {
        if (typeof marked !== 'undefined' && text) {
            return marked.parse(text);
        }
        return text || '';
    }

    // --- REPORT LOGIC ---
    document.getElementById('reportForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const reason = document.getElementById('reportReason').value;

        try {
            const res = await authFetch(`${API_BASE}/reports/create/`, {
                method: 'POST',
                body: JSON.stringify({
                    reason: reason,
                    thread: THREAD_ID, 
                    model_type: 'Thread'
                })
            });

            if (res.ok) {
                alert("Report submitted. Moderators will review it.");
                bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
                document.getElementById('reportReason').value = '';
            } else {
                alert("Error submitting report.");
            }
        } catch (error) {
            console.error(error);
            alert("Network error submitting report.");
        }
    });

    // --- LOAD USER ---
    async function loadCurrentUser() {
        try {
            const res = await authFetch(`${API_BASE}/me/`);
            if (res.ok) {
                const user = await res.json();
                CURRENT_USER_EMAIL = user.email;
                localStorage.setItem('user_role', user.role); 
            }
        } catch (e) { console.error("Could not fetch user", e); }
    }

    // --- LOAD THREAD ---
    async function loadThreadDetail() {
        if (!THREAD_ID || isNaN(THREAD_ID)) {
            alert("Invalid Thread URL"); return;
        }

        try {
            const res = await authFetch(`${API_BASE}/threads/${THREAD_ID}/`);
            if (!res.ok) throw new Error(`Failed to load thread`);
            const data = await res.json();
            
            // Populate UI
            document.getElementById('t-title').textContent = data.title;
            // NEW: Markdown Parsing
            document.getElementById('t-content').innerHTML = renderMarkdown(data.content);
            
            document.getElementById('t-category').textContent = data.category_name || "General";
            document.getElementById('t-author').textContent = `Posted by ${data.author_email}`;
            document.getElementById('t-date').textContent = new Date(data.created_at).toLocaleDateString();
            document.getElementById('t-likes').textContent = data.like_count;
            document.getElementById('reply-count').textContent = data.reply_count;

            // Render Tags
            const tagsHtml = (data.tags || []).map(tag => 
                `<span class="badge bg-info text-dark ms-2">#${tag.name}</span>`
            ).join('');
            
            const catBadge = document.getElementById('t-category');
            let next = catBadge.nextElementSibling;
            while(next && next.tagName === 'SPAN' && next.classList.contains('bg-info')) {
                next.remove();
                next = catBadge.nextElementSibling;
            }
            catBadge.insertAdjacentHTML('afterend', tagsHtml);

            // Handle Locked/Pinned
            if (data.is_locked) {
                document.getElementById('locked-icon').classList.remove('d-none');
                document.getElementById('reply-section').classList.add('d-none');
                document.getElementById('locked-message').classList.remove('d-none');
                document.getElementById('lock-btn').innerHTML = '<i class="fas fa-lock-open"></i>';
            }
            if (data.is_pinned) {
                document.getElementById('pinned-icon').classList.remove('d-none');
                document.getElementById('pin-btn').classList.add('active', 'text-warning');
            }

            // Permission Check
            const userRole = localStorage.getItem('user_role');
            const isAuthor = (data.author_email === CURRENT_USER_EMAIL);
            const isMod = (userRole === 'moderator');

            if (isAuthor || isMod) {
                document.getElementById('mod-actions').classList.remove('d-none');
            }
            
            if (!isMod) {
                document.getElementById('lock-btn').classList.add('d-none');
                document.getElementById('pin-btn').classList.add('d-none');
            }

            // --- LOAD REPLIES ---
            const rContainer = document.getElementById('replies-container');
            rContainer.innerHTML = '';
            
            (data.replies || []).forEach(reply => {
                const canDeleteReply = (reply.author_email === CURRENT_USER_EMAIL) || isMod;
                const deleteBtn = canDeleteReply ? 
                    `<button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteReply(${reply.id})"><i class="fas fa-trash-alt"></i></button>` : '';

                const heartClass = reply.user_liked ? 'fas text-danger' : 'far';

                rContainer.innerHTML += `
                <div class="card mb-2 shadow-sm">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong class="text-primary">${reply.author_email}</strong>
                                <small class="text-muted ms-2">${new Date(reply.created_at).toLocaleDateString()}</small>
                            </div>
                            <div>${deleteBtn}</div>
                        </div>
                        <div class="mt-2 mb-0">${renderMarkdown(reply.content)}</div>
                        
                        <div class="mt-2">
                            <button class="btn btn-sm btn-link text-decoration-none p-0" onclick="likeReply(${reply.id}, this)">
                                <i class="${heartClass} fa-heart"></i> <span>${reply.like_count || 0}</span> Likes
                            </button>
                        </div>
                    </div>
                </div>`;
            });

            document.getElementById('loader').classList.add('d-none');
            document.getElementById('content').classList.remove('d-none');

        } catch (error) {
            console.error(error);
            document.getElementById('loader').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    }

    // --- BUTTON ACTIONS ---
    async function postReply() {
        const content = document.getElementById('replyContent').value;
        if (!content) return alert("Reply cannot be empty");

        const res = await authFetch(`${API_BASE}/threads/${THREAD_ID}/replies/create/`, {
            method: 'POST',
            body: JSON.stringify({ content: content })
        });

        if (res.ok) {
            document.getElementById('replyContent').value = '';
            loadThreadDetail(); 
        } else {
            alert("Error posting reply.");
        }
    }

    async function deleteThread() {
        if(!confirm("Are you sure you want to delete this thread?")) return;
        const res = await authFetch(`${API_BASE}/threads/${THREAD_ID}/delete/`, { method: 'DELETE' });
        if (res.ok) window.location.href = '/forum/';
        else alert("Permission denied.");
    }

    async function toggleLock() {
        const res = await authFetch(`${API_BASE}/threads/${THREAD_ID}/lock/`, { method: 'POST' });
        if (res.ok) loadThreadDetail();
        else alert("Only moderators can lock threads.");
    }

    async function togglePin() {
        const res = await authFetch(`${API_BASE}/threads/${THREAD_ID}/pin/`, { method: 'POST' });
        if (res.ok) loadThreadDetail();
        else alert("Only moderators can pin threads.");
    }
    
    async function deleteReply(id) {
        if(!confirm("Delete this reply?")) return;
        const res = await authFetch(`${API_BASE}/replies/${id}/delete/`, { method: 'DELETE' });
        if (res.ok) loadThreadDetail();
    }

    async function likeThread() {
        await authFetch(`${API_BASE}/threads/${THREAD_ID}/like/`, { method: 'POST' });
        loadThreadDetail();
    }
    
    async function likeReply(id, btn) {
        await authFetch(`${API_BASE}/replies/${id}/like/`, { method: 'POST' });
        loadThreadDetail(); 
    }
</script>
{% endblock %}