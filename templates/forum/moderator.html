{% extends 'forum/base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-shield-alt text-primary"></i> Moderator Dashboard</h2>
</div>

<div class="card shadow-sm">
    <div class="card-header bg-white">
        <ul class="nav nav-tabs card-header-tabs">
            <li class="nav-item">
                <a class="nav-link active" href="#">Pending Reports</a>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Reported By</th>
                        <th>Reason</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="report-list">
                    <tr><td colspan="4" class="text-center">Loading reports...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', loadReports);

    async function loadReports() {
        // Fetch reports (Backend checks if you are moderator)
        const res = await authFetch(`${API_BASE}/reports/pending/`);
        
        if (res.status === 403) {
            document.querySelector('.container').innerHTML = '<div class="alert alert-danger">Access Denied: Moderators Only</div>';
            return;
        }

        const data = await res.json();
        const list = document.getElementById('report-list');
        list.innerHTML = '';

        if (data.results.length === 0) {
            list.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No pending reports. Good job!</td></tr>';
            return;
        }

        data.results.forEach(report => {
            list.innerHTML += `
                <tr>
                    <td>${report.reporter_email || 'User'}</td>
                    <td>${report.reason}</td>
                    <td>${new Date(report.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="resolveReport(${report.id})">
                            <i class="fas fa-check"></i> Resolve
                        </button>
                        <a href="/thread/${report.thread_id}/" class="btn btn-sm btn-outline-primary" target="_blank">
                            View Content
                        </a>
                    </td>
                </tr>
            `;
        });
    }

    async function resolveReport(id) {
        if(!confirm("Mark this report as resolved?")) return;
        
        const res = await authFetch(`${API_BASE}/reports/${id}/resolve/`, { 
            method: 'PATCH',
            body: JSON.stringify({ status: 'resolved' })
        });
        
        if (res.ok) {
            loadReports(); // Refresh list
        } else {
            alert("Error resolving report");
        }
    }
</script>
{% endblock %}